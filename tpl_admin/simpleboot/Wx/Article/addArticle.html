<admintpl file="header"/>

<script type="text/javascript"  src="__ROOT__/statics/ueditor/ueditor.config.js"></script>
<script type="text/javascript"  src="__ROOT__/statics/ueditor/ueditor.all.min.js"></script>
<style type="text/css">
    .col-auto {
        overflow: hidden;
        _zoom: 1;
        _float: left;
        border: 1px solid #c2d1d8;
    }
    .col-right {
        float: right;
        width: 210px;
        overflow: hidden;
        margin-left: 6px;
        border: 1px solid #c2d1d8;
    }

    body fieldset {
        border: 1px solid #D8D8D8;
        padding: 10px;
        background-color: #FFF;
    }
    body fieldset legend {
        padding: 3px 8px;
    }
    .list-dot{ padding-bottom:10px}
    .list-dot li,.list-dot-othors li{padding:5px 0; border-bottom:1px dotted #c6dde0; font-family:"宋体"; color:#bbb; position:relative;_height:22px}
    .list-dot li span,.list-dot-othors li span{color:#004499}
    .list-dot li a.close span,.list-dot-othors li a.close span{display:none}
    .list-dot li a.close,.list-dot-othors li a.close{ background: url("__ROOT__/statics/images/cross.png") no-repeat left 3px; display:block; width:16px; height:16px;position: absolute;outline:none;right:5px; bottom:5px}
    .list-dot li a.close:hover,.list-dot-othors li a.close:hover{background-position: left -46px}
    .list-dot-othors li{float:left;width:24%;overflow:hidden;}
    .col-top{height: 150px;border:1px solid #c2d1d8;margin-bottom: 2px;position:relative}
    .reply-news-list-detail {
        width: 100%;
        position: absolute;
        bottom: 0;
        left: 0;
        overflow: hidden;
        height: 50px;
        color: #FFF;
        filter: Alpha(opacity=70);
        background: #000;
        background: rgba(0, 0, 0, 0.7);
        text-shadow: none;
        font-family: arial,宋体b8b\4f53,sans-serif;
    }
    #wxhidden{
        display: none;
    }
    .right{
        float: right;
        margin: 0;
        width: 24%;
        overflow: hidden;
    }
    .wxlist{

        overflow: hidden;
        border: 1px solid #e7e7eb;
    }
    .appmsg_item{
        position: relative;
        margin: 0px auto;
        height: 150px;
        width: 100%;
        border-top: 1px solid #e7e7eb;
    }
	.appmsg_item h2{
        color: #000;
        position: absolute;
        top: 50px;
        font-weight: normal;
        font-size: 20px;
		text-indent: 10px
    }
    .appmsg_item:FIRST-CHILD h2{
		color: #ffffff;
    }
    .appmsg_item img{
        margin-top: 40px;
        margin-right: 15px;
        float: right;
        width: 80px;
        height: 80px;
    }
    .js_appmsg_item h2{
        display: block;
        top: 105px;
        height: 35px;
        width: 100%;
        background: rgba(0, 0, 0, 0.7);
    }
    .js_appmsg_item img{
        margin: 0px;
        height: 150px;
        width: 100%;
    }
    .appmsg_edit_mask{
        display: none;
        line-height: 150px;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(229,229,229,0.85)!important;;
        text-align: center;
    }
    .appmsg_item:hover .appmsg_edit_mask {
        display: block;
    }
    .appmsg_edit_mask a {
        margin-left: 8px;
        margin-right: 8px;
    }
    .js_appmsg_item .del_gray{
        display: none;
    }
    .icon18_common {
        width: 20px;
        height: 20px;
        vertical-align: middle;
        display: inline-block;
        line-height: 100px;
        overflow: hidden;
    }
    .icon18_common.edit_gray {
        background: url("__STATICS__/images/tpl/wxicon.png")  0px -46px  no-repeat;
    }
    .icon18_common.add_gray {
        background: url("__STATICS__/images/tpl/wxicon.png") no-repeat;
    }
    .icon18_common.del_gray {
        background: url("__STATICS__/images/tpl/wxicon.png") 0 -95px no-repeat;
    }
    .addlist{
        height: 90px;
        border: 2px dotted #d9dadc;
        line-height: 60px;
        background: url("__STATICS__/images/tpl/wxadd.png") no-repeat center;
        cursor: pointer;

    }
</style>
</head>
<body class="J_scroll_fixed">
<div class="wrap J_check_wrap">
    <ul class="nav nav-tabs">
        <li><a href="{:U('Article/index')}">素材列表</a></li>
        <li><a href="{:U('Article/add')}">添加素材</a></li>
        <li class="active"><a href=""  target="_self">添加图文</a></li>
    </ul>
    <form name="myform" id="myform" action="{:u('Wx/Article/addArticle/uid')}/{$uid}" method="post" class="form-horizontal J_ajaxForms" style="width: 75%; float: left" enctype="multipart/form-data">
        <div class="row" style="margin:0">

        </div>

        <div class="form-actions">
            <button class="btn btn-primary btn_submit J_ajax_submit_btn" type="submit">提交</button>
            <a class="btn" href="{:U('Article/index')}">返回</a>
        </div>
    </form>
    <div id="wxhidden">
        <div class="reply-item item">
            <div id="wxlist">
                <div id="appmsgitem1" style="display: none;" class="appmsg_item">
                    <img src="" alt=""/>
                    <h2>
                        标题
                    </h2>
                    <div class="appmsg_edit_mask" >
                        <a class="icon18_common edit_gray js_edit" data-id="1" onclick="javascript:wxedit('appmsgitem1','(item-add-form)');" href="javascript:void(0);">编辑</a>
                        <a class="icon18_common del_gray js_del" data-id="1" onclick="javascript:wxdel('appmsgitem1','(item-add-form)');" href="javascript:void(0);">删除</a>
                    </div>

                </div>
            </div>
            <div id="(item-add-form)">

                <div class="col-auto">
                    <div class="table_full">
                        <table width="100%" cellpadding="2" cellspacing="2">
                            <tr>
                                <th width="80">标题 </th>
                                <td>
                                    <input type="text" style="width:400px;" name="(item-add-form)[post_title]" id="title" value=""  class="input input_hd J_title_color" placeholder="请输入标题" onkeyup="strlen_verify(this, 'title_len', 160)" />
                                    <span class="must_red">*</span>
                                </td>
                            </tr>
                            <tr>
                                <th width="80">作者</th>
                                <td>
                                    <input type="text" width="80" name="(item-add-form)[post_author]" id="author" value=""  class="input input_hd J_title_color" placeholder="" />
                                    <span class="must_red">*</span>
                                </td>
                            </tr>
                            <!--<tr>
                                <th width="80">排序</th>
                                <td>
                                    <input type="text" width="80" name="displayorder[]" id="displayorder" value=""  class="input input_hd J_title_color" placeholder="" />
                                    <span class="must_red">排序只能在提交后显示。按照从大到小的顺序对图文排序</span>
                                </td>
                            </tr>-->
                            <tr>
                                <th width="80">图片上传</th>
                                <td>
                                    <input type='hidden' name="(item-add-form)[post_pic]" id='thumb-show-1' value='' />
                                    <a href='javascript:void(0);' onclick="flashupload('thumb_images', '附件上传','thumb-show-1',thumb_images,'1,jpg|jpeg|gif|png|bmp,1,,,1','','','');return false;"><input type="button"  class="" value="图片上传">
                                    </a>

                                </td>
                            </tr>

                            <tr>
                                <th width="80">摘要 </th>
                                <td><textarea name="(item-add-form)[post_excerpt]" id='description'  style='width:98%;height:50px;' placeholder='请填写摘要'></textarea> </td>
                            </tr>
                            <tr>
                                <th width="80">内容</th>
                                <td>
                                    <script type="text/plain" id="item-content-1" class="content" name="(item-add-form)[post_content]"></script>
                                </td>
                            </tr>
                            <tr>
                                <th width="80">链接地址 </th>
                                <td>
                                    <input type="text" name="(item-add-form)[post_url]" class="input input_hd J_title_color" placeholder="填写链接地址后，作品内容将无效" style="width:400px;"/>
                                </td>
                            </tr>

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="right">
        <div class="wxlist">
        </div>
        <div style="clear: both"></div>
        <div class="addlist addpic">
        </div>
    </div>


</div>
<script type="text/javascript" src="__ROOT__/statics/js/common.js"></script>
<script type="text/javascript" src="__ROOT__/statics/js/content_addtop.js"></script>


<script>
    size = $('.reply-item').size()-1;
    if (size == 0){
        buildForm();
    }
    function buildForm(){
        var size = $('.reply-item').size()-1;
        var html = $('#wxhidden').html().replace(/\(item-add-form\)/gm, 'item-form-' + (1+size)).
        replace('item-content-1','item-content-'+(1+size)).replace('delpic-1','delpic-'+(1+size)).
        replace('hiddenpic-1','hiddenpic-'+(1+size)).replace(/thumb-show-1/g,'thumb-show-'+(1+size)).replace(/appmsgitem1/g,'appmsgitem'+(1+size));
        $('#myform .row').append(html);
        $("#item-form-"+(1+size)).parent().siblings().css('display','none');
        $('.wxlist').append($("#item-form-"+(1+size)).parent().find("#wxlist").html()).find('.appmsg_item').css('display','block');
        $('.wxlist .appmsg_item:first').addClass('js_appmsg_item');
        UE.getEditor("item-content-"+(1+size));
        var content = $('#')
    }
    $('.addpic').click(function () {
        var itemid = $(".reply-item[style!='display: none;']").find('.appmsg_item').attr('id');
        var formid = $(".reply-item[style!='display: none;']").find("div[id*='item-form']").attr('id');
        wxsave(itemid,formid);
        if(flag){
            buildForm();
        }

    })
    function wxdel(itemid,formid){
        $('.wxlist').find('#'+itemid).remove();
        $('#'+formid).remove();
    }
    function wxedit(itemid,formid){
        var previtemid = $(".reply-item[style!='display: none;']").find('.appmsg_item').attr('id');
        var prevformid = $(".reply-item[style!='display: none;']").find("div[id*='item-form']").attr('id');
        wxsave(previtemid,prevformid);
        if(flag){
            $('#'+formid).parent().css('display','block').siblings().css('display', 'none');
        }

    }

    function artDialog_alert(content,elemet){
        Wind.use("artDialog",function(){
            art.dialog({
                id:'error',
                icon:'error',
                fixed: true,
                lock: true,
                background:"#CCCCCC",
                opacity:0,
                content: content,
                zIndex:12000,
                cancelVal: '确定',
                cancel: function(){
                    elemet.focus();
                }
            });
        });
    }

    function wxsave(itemid,formid){
        if($('#'+formid).find("input[name*='post_title']").val() ==''){
            artDialog_alert('请输入标题',$('#'+formid).find("input[name*='post_title']"));
            flag = false;
            return false;
        }else if($('#'+formid).find("input[name*='post_pic']").val() == ''){
            artDialog_alert('请选择封面图片',$('#'+formid).find("input[name*='post_pic']"));
            flag = false;
            return false;
        }else{
            $('.wxlist').find('#'+itemid).find('img').attr('src',$('#'+formid).find("input[name*='post_pic']").val());
            $('.wxlist').find('#'+itemid).find('h2').text($('#'+formid).find("input[name*='post_title']").val());
            flag = true;
        }
    }

</script>
<script type="text/javascript">
    $('.btn').click(function(){
        var previtemid = $(".reply-item[style!='display: none;']").find('.appmsg_item').attr('id');
        var prevformid = $(".reply-item[style!='display: none;']").find("div[id*='item-form']").attr('id');
        wxsave(previtemid,prevformid);
        if(!flag){
            return false;
        }else{
            var form = $('form.J_ajaxForms');
            var formData = form.serialize();
            var url = form.attr("action");
            $.post(url,formData,function(data){
                if (data.status) {
                    setCookie("refersh_time", 1);
                    //添加成功
                    Wind.use("artDialog", function () {
                        art.dialog({
                            id: "succeed",
                            icon: "succeed",
                            fixed: true,
                            lock: true,
                            background: "#CCCCCC",
                            opacity: 0,
                            content: data.info,
                            button: [
                                {
                                    name: '继续添加？',
                                    callback: function () {
                                        reloadPage(window);
                                        return true;
                                    },
                                    focus: true
                                }, {
                                    name: '返回列表页',
                                    callback: function () {
                                        location = "{:U('Article/index')}";
                                        return true;
                                    }
                                }
                            ]
                        });
                    });
                } else {
                    isalert(data.info);
                }
            });
            return false;
        }
    })
</script>

</body>
</html>
